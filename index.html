
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOYNA - Local Voice Translator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 20px; }
    #output { font-size: 24px; margin-top: 30px; color: green; white-space: pre-line; }
  </style>
</head>
<body>
  <h2>üå∏ MOYNA</h2>
  <h3>üé§ MOYNA - Speak Your Language</h3>
  <p>Click the button and speak. We'll translate it to English.</p>
  <button onclick="startRecognition()">Start Speaking</button>
  <div id="output">Waiting for input...</div>

  <script>
    const output = document.getElementById("output");
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'bn-BD';
    recognition.interimResults = true;
    recognition.continuous = true;

    let finalTranscript = '';
    let lastSpokenTime = Date.now();
    let timeoutHandle = null;

    const punctuationMap = {
      'comma': ',',
      'full stop': '.',
      'period': '.',
      'semicolon': ';'
    };

    function replaceSpokenPunctuation(text) {
      let words = text.split(/\s+/);
      return words.map(word => punctuationMap[word.toLowerCase()] || word).join(' ');
    }

    function startRecognition() {
      output.innerText = "Listening...";
      finalTranscript = '';
      recognition.start();
    }

    recognition.onresult = function(event) {
      let interimTranscript = '';
      let currentTime = Date.now();
      let pauseDuration = (currentTime - lastSpokenTime) / 1000;
      lastSpokenTime = currentTime;

      for (let i = event.resultIndex; i < event.results.length; ++i) {
        let transcript = event.results[i][0].transcript.trim();
        transcript = replaceSpokenPunctuation(transcript);

        if (event.results[i].isFinal) {
          if (pauseDuration >= 2.5) {
            finalTranscript += transcript + '. ';
          } else if (pauseDuration >= 2) {
            finalTranscript += transcript + '. ';
          } else if (pauseDuration >= 1.3) {
            finalTranscript += transcript + ', ';
          } else {
            finalTranscript += transcript + ' ';
          }
        } else {
          interimTranscript += transcript + ' ';
        }
      }

      output.innerText = `You said: "${finalTranscript + interimTranscript}"`;

      clearTimeout(timeoutHandle);
      timeoutHandle = setTimeout(() => {
        recognition.stop();
        const fullText = (finalTranscript + interimTranscript).trim();
        if (fullText.length === 0) return;
        translateText(fullText);
        logUsage(fullText);
      }, 3000);
    };

    recognition.onerror = function(event) {
      output.innerText = `‚ùå ‡¶ï‡ßã‡¶•‡¶æ‡¶ì ‡¶è‡¶ï‡¶ü‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶∞‡ßç‡¶¨‡¶ö‡ßç‡¶ö ‡¶ö‡¶¨‡ßç‡¶¨‡¶ø‡¶∂ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶ø‡•§`;
      logError(event.error);
    };

    function translateText(text) {
      if (!text) return;
      fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=bn|en`)
        .then(response => response.json())
        .then(data => {
          const translated = data.responseData.translatedText;
          const punctuated = translated.replace(/\s*([\.,!?;])\s*/g, '$1 ').replace(/ +/g, ' ');
          output.innerText += `\n‚û°Ô∏è Translation: "${punctuated.trim()}"`;
        })
        .catch(err => {
          output.innerText += `\n‚ùå Translation failed.`;
          logError(err.message);
        });
    }

    function logUsage(text) {
      fetch('https://your-server.com/api/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ input: text, timestamp: new Date().toISOString(), user: getUserId() })
      });
    }

    function logError(errorMsg) {
      fetch('https://your-server.com/api/error', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ error: errorMsg, timestamp: new Date().toISOString(), user: getUserId() })
      });
    }

    function getUserId() {
      let user = localStorage.getItem('moyna_user');
      if (!user) {
        user = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('moyna_user', user);
      }
      return user;
    }
  </script>
</body>
</html>
